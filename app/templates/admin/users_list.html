{% extends "admin/base.html" %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="admin-title">
        <i class="fas fa-users me-2"></i> Gestión de Usuarios
    </h1>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ total_users }}</div>
                    <div class="stat-label">Total Usuarios</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ active_users }}</div>
                    <div class="stat-label">Usuarios Activos</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-number">{{ total_admins }}</div>
                    <div class="stat-label">Administradores</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="admin-panel mb-4">
    <div class="admin-panel-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label" style="color: var(--admin-text);">Buscar usuario</label>
                <input type="text" name="search" class="form-control" 
                       placeholder="Nombre, email o username..." 
                       value="{{ search }}"
                       style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text);">
            </div>
            <div class="col-md-3">
                <label class="form-label" style="color: var(--admin-text);">Filtrar por rol</label>
                <select name="role" class="form-select" 
                        style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text);">
                    <option value="">Todos</option>
                    <option value="user" {% if filter_role == 'user' %}selected{% endif %}>Usuarios</option>
                    <option value="admin" {% if filter_role == 'admin' %}selected{% endif %}>Administradores</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="admin-btn admin-btn-primary w-100">
                    <i class="fas fa-search me-1"></i> Buscar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="admin-panel">
    <div class="admin-panel-header">
        <i class="fas fa-list"></i>
        <h5>Lista de Usuarios ({{ users.total }})</h5>
    </div>
    <div class="admin-panel-body" style="padding: 0;">
        {% if users.items %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Avatar</th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Nombre</th>
                        <th>Registrado</th>
                        <th>Último Acceso</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users.items %}
                    <tr>
                        <td>
                            <img src="{{ user.get_avatar_url(45) }}" 
                                 alt="{{ user.username }}" 
                                 style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid {% if user.is_admin %}rgba(255, 193, 7, 0.5){% else %}rgba(0, 212, 255, 0.3){% endif %};">
                        </td>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.email_verified %}
                            <i class="fas fa-check-circle" style="color: #00ff88; font-size: 0.8rem;" title="Email verificado"></i>
                            {% endif %}
                        </td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.display_name }}</td>
                        <td>{{ user.created_at.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if user.last_login %}
                                {{ user.last_login.strftime('%d/%m/%Y %H:%M') }}
                            {% else %}
                                <span style="color: var(--admin-text-muted);">Nunca</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_admin %}
                                <span class="admin-badge warning">
                                    <i class="fas fa-shield-alt me-1"></i> Admin
                                </span>
                            {% else %}
                                <span class="admin-badge primary">
                                    <i class="fas fa-user me-1"></i> Usuario
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="admin-badge success">Activo</span>
                            {% else %}
                                <span class="admin-badge danger">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                {% if not user.is_admin %}
                                <!-- Toggle Status -->
                                <form action="{{ url_for('admin.toggle_user_status', user_id=user.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="admin-btn {% if user.is_active %}admin-btn-warning{% else %}admin-btn-success{% endif %}" 
                                            style="padding: 5px 10px; font-size: 0.75rem;"
                                            title="{% if user.is_active %}Desactivar{% else %}Activar{% endif %}">
                                        <i class="fas fa-{% if user.is_active %}ban{% else %}check{% endif %}"></i>
                                    </button>
                                </form>
                                
                                <!-- Toggle Admin -->
                                <form action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="admin-btn admin-btn-info" 
                                            style="padding: 5px 10px; font-size: 0.75rem;"
                                            title="Hacer admin"
                                            onclick="return confirm('¿Convertir a {{ user.username }} en administrador?');">
                                        <i class="fas fa-user-shield"></i>
                                    </button>
                                </form>
                                
                                <!-- Delete -->
                                <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="admin-btn admin-btn-danger" 
                                            style="padding: 5px 10px; font-size: 0.75rem;"
                                            title="Eliminar usuario"
                                            onclick="return confirm('¿Eliminar al usuario {{ user.username }}? Esta acción no se puede deshacer.');">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% else %}
                                {% if user.id != current_user.id %}
                                <!-- Remove Admin -->
                                <form action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="admin-btn admin-btn-outline" 
                                            style="padding: 5px 10px; font-size: 0.75rem;"
                                            title="Quitar admin"
                                            onclick="return confirm('¿Quitar permisos de admin a {{ user.username }}?');">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                </form>
                                {% else %}
                                <span style="color: var(--admin-text-muted); font-size: 0.8rem;">Tú</span>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if users.pages > 1 %}
        <div class="d-flex justify-content-center p-3">
            <nav aria-label="Paginación de usuarios">
                <ul class="pagination mb-0">
                    {% if users.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.users_list', page=users.prev_num, search=search, role=filter_role) }}" 
                           style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text);">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for p in users.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if p %}
                            {% if p == users.page %}
                            <li class="page-item active">
                                <span class="page-link" style="background: var(--admin-primary); border-color: var(--admin-primary);">{{ p }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.users_list', page=p, search=search, role=filter_role) }}"
                                   style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text);">{{ p }}</a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text-muted);">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if users.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.users_list', page=users.next_num, search=search, role=filter_role) }}"
                           style="background: var(--admin-bg-secondary); border-color: var(--admin-border); color: var(--admin-text);">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x mb-3" style="color: var(--admin-text-muted);"></i>
            <p style="color: var(--admin-text-muted);">No se encontraron usuarios</p>
            {% if search or filter_role %}
            <a href="{{ url_for('admin.users_list') }}" class="admin-btn admin-btn-outline">
                <i class="fas fa-times me-1"></i> Limpiar filtros
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
