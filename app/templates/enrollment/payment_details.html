{% extends "base.html" %}

{% block title %}Información de Pago - {{ enrollment.course.title }}{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script src="https://www.paypal.com/sdk/js?client-id=demo&currency=MXN"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Header -->
            <div class="text-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-credit-card me-2"></i>
                    Métodos de Pago
                </h2>
                <p class="text-muted">Curso: <strong>{{ enrollment.course.title }}</strong></p>
                <h3 class="text-success">${{ "%.2f"|format(enrollment.enrolled_price) }} MXN</h3>
            </div>

            <!-- Pestañas de Métodos de Pago -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-pills nav-justified" id="paymentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="card-tab" data-bs-toggle="pill" data-bs-target="#card-payment" type="button" role="tab">
                                <i class="fas fa-credit-card me-2"></i>
                                Tarjeta de Crédito/Débito
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="paypal-tab" data-bs-toggle="pill" data-bs-target="#paypal-payment" type="button" role="tab">
                                <i class="fab fa-paypal me-2"></i>
                                PayPal
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mercadopago-tab" data-bs-toggle="pill" data-bs-target="#mercadopago-payment" type="button" role="tab">
                                <i class="fas fa-shopping-cart me-2"></i>
                                MercadoPago
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="bank-tab" data-bs-toggle="pill" data-bs-target="#bank-payment" type="button" role="tab">
                                <i class="fas fa-university me-2"></i>
                                Transferencia Bancaria
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="paymentTabsContent">
                        
                        <!-- Tarjeta de Crédito/Débito -->
                        <div class="tab-pane fade show active" id="card-payment" role="tabpanel">
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <form id="card-payment-form" action="{{ url_for('enrollment.process_card_payment', enrollment_id=enrollment.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="payment_method" value="credit_card"/>
                                        
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <label for="card_number" class="form-label">Número de Tarjeta</label>
                                                <input type="text" class="form-control" id="card_number" name="card_number" 
                                                       placeholder="1234 5678 9012 3456" maxlength="19" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-8">
                                                <label for="card_name" class="form-label">Nombre en la Tarjeta</label>
                                                <input type="text" class="form-control" id="card_name" name="card_name" 
                                                       placeholder="Juan Pérez" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="card_cvv" class="form-label">CVV</label>
                                                <input type="text" class="form-control" id="card_cvv" name="card_cvv" 
                                                       placeholder="123" maxlength="4" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="card_expiry_month" class="form-label">Mes de Expiración</label>
                                                <select class="form-control" id="card_expiry_month" name="card_expiry_month" required>
                                                    <option value="">Seleccionar</option>
                                                    {% for i in range(1, 13) %}
                                                    <option value="{{ "%02d"|format(i) }}">{{ "%02d"|format(i) }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="card_expiry_year" class="form-label">Año de Expiración</label>
                                                <select class="form-control" id="card_expiry_year" name="card_expiry_year" required>
                                                    <option value="">Seleccionar</option>
                                                    {% for year in range(2025, 2036) %}
                                                    <option value="{{ year }}">{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-shield-alt me-2"></i>
                                            <strong>Pago Seguro:</strong> Todos los datos de tu tarjeta están protegidos con encriptación SSL.
                                        </div>
                                        
                                        <button type="submit" class="btn btn-success btn-lg w-100">
                                            <i class="fas fa-credit-card me-2"></i>
                                            Pagar ${{ "%.2f"|format(enrollment.enrolled_price) }} MXN
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- PayPal -->
                        <div class="tab-pane fade" id="paypal-payment" role="tabpanel">
                            <div class="text-center">
                                <div class="alert alert-info">
                                    <i class="fab fa-paypal fa-2x mb-2"></i><br>
                                    <strong>Pago con PayPal</strong><br>
                                    Serás redirigido a PayPal para completar tu pago de forma segura.
                                </div>
                                
                                <div id="paypal-button-container" style="max-width: 400px; margin: 0 auto;"></div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-lock me-1"></i>
                                        Pago procesado por PayPal - 100% seguro
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- MercadoPago -->
                        <div class="tab-pane fade" id="mercadopago-payment" role="tabpanel">
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="text-center mb-4">
                                        <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                        <h4>Pago con MercadoPago</h4>
                                        <p class="text-muted">Acepta tarjetas de crédito, débito, efectivo y más.</p>
                                    </div>
                                    
                                    <form action="{{ url_for('enrollment.process_mercadopago', enrollment_id=enrollment.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="payment_method" value="mercadopago"/>
                                        
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-credit-card me-2"></i>Métodos Disponibles:</h6>
                                                        <ul class="list-unstyled">
                                                            <li><i class="fas fa-check text-success me-1"></i> Visa, Mastercard, American Express</li>
                                                            <li><i class="fas fa-check text-success me-1"></i> Tarjetas de débito</li>
                                                            <li><i class="fas fa-check text-success me-1"></i> Efectivo (OXXO, 7-Eleven)</li>
                                                            <li><i class="fas fa-check text-success me-1"></i> Transferencia bancaria</li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6><i class="fas fa-shield-alt me-2"></i>Seguridad:</h6>
                                                        <ul class="list-unstyled">
                                                            <li><i class="fas fa-check text-success me-1"></i> Certificado SSL</li>
                                                            <li><i class="fas fa-check text-success me-1"></i> Protección al comprador</li>
                                                            <li><i class="fas fa-check text-success me-1"></i> Sin cargos adicionales</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            <i class="fas fa-shopping-cart me-2"></i>
                                            Ir a MercadoPago - ${{ "%.2f"|format(enrollment.enrolled_price) }} MXN
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Transferencia Bancaria -->
                        <div class="tab-pane fade" id="bank-payment" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">
                                                <i class="fas fa-university me-2"></i>
                                                Cuentas Bancarias
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            {% for bank in bank_accounts %}
                                            <div class="bank-account mb-4 p-3 border rounded">
                                                <h6 class="text-primary">{{ bank.bank_name }}</h6>
                                                <div class="row text-sm">
                                                    <div class="col-6">
                                                        <strong>Tipo:</strong><br>
                                                        {{ bank.account_type }}
                                                    </div>
                                                    <div class="col-6">
                                                        <strong>Número:</strong><br>
                                                        <code>{{ bank.account_number }}</code>
                                                    </div>
                                                </div>
                                                <div class="row text-sm mt-2">
                                                    <div class="col-6">
                                                        <strong>Titular:</strong><br>
                                                        {{ bank.account_holder }}
                                                    </div>
                                                    <div class="col-6">
                                                        <strong>Código:</strong><br>
                                                        <code>{{ bank.routing_number }}</code>
                                                    </div>
                                                </div>
                                                <button class="btn btn-outline-success btn-sm mt-2" 
                                                        onclick="copyToClipboard('{{ bank.account_number }}')">
                                                    <i class="fas fa-copy me-1"></i>
                                                    Copiar Número
                                                </button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">
                                                <i class="fas fa-upload me-2"></i>
                                                Subir Comprobante de Pago
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-warning">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Instrucciones:</strong><br>
                                                1. Realiza la transferencia a cualquiera de las cuentas<br>
                                                2. Toma una foto del comprobante<br>
                                                3. Súbelo usando el botón de abajo
                                            </div>
                                            
                                            <div class="text-center">
                                                <a href="{{ url_for('enrollment.submit_payment', enrollment_id=enrollment.id) }}" 
                                                   class="btn btn-success btn-lg">
                                                    <i class="fas fa-file-upload me-2"></i>
                                                    Subir Comprobante
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón de navegación -->
            <div class="text-center mt-4">
                <a href="{{ url_for('enrollment.my_enrollments') }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-list me-2"></i>
                    Ver Mis Inscripciones
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Formateo automático del número de tarjeta
document.getElementById('card_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue.length <= 19) {
        e.target.value = formattedValue;
    }
});

// Validación CVV
document.getElementById('card_cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/gi, '');
});

// PayPal Integration
paypal.Buttons({
    createOrder: function(data, actions) {
        return actions.order.create({
            purchase_units: [{
                amount: {
                    value: '{{ "%.2f"|format(enrollment.enrolled_price) }}'
                }
            }]
        });
    },
    onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
            // Enviar información del pago al servidor
            fetch('{{ url_for("enrollment.process_paypal_payment", enrollment_id=enrollment.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({
                    orderID: data.orderID,
                    payerID: data.payerID,
                    details: details
                })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    alert('¡Pago completado exitosamente!');
                    window.location.href = '{{ url_for("enrollment.my_enrollments") }}';
                } else {
                    alert('Error al procesar el pago: ' + data.message);
                }
            });
        });
    },
    onError: function(err) {
        console.error('Error en PayPal:', err);
        alert('Error al procesar el pago con PayPal');
    }
}).render('#paypal-button-container');

// Función para copiar al portapapeles
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('Número de cuenta copiado al portapapeles');
    });
}
</script>

<style>
.nav-pills .nav-link {
    color: #495057;
    border-radius: 0;
    border-bottom: 2px solid transparent;
}

.nav-pills .nav-link.active {
    background-color: transparent;
    color: #007bff;
    border-bottom-color: #007bff;
}

.bank-account {
    transition: all 0.3s ease;
}

.bank-account:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#card_number {
    font-family: 'Courier New', monospace;
    font-size: 1.1em;
}
</style>
                </div>

                <!-- Instrucciones de Pago -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ol me-2"></i>
                                Instrucciones de Pago
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="payment-methods">
                                <!-- Transferencia Bancaria -->
                                <div class="payment-method mb-4">
                                    <h6 class="text-primary">
                                        <i class="fas fa-university me-2"></i>
                                        Transferencia Bancaria
                                    </h6>
                                    <ol class="small">
                                        <li>Realiza la transferencia a cualquiera de las cuentas mostradas</li>
                                        <li>Guarda el comprobante de la transacción</li>
                                        <li>Anota el número de referencia/ID de transacción</li>
                                        <li>Sube el comprobante usando el formulario de abajo</li>
                                    </ol>
                                </div>

                                <!-- PayPal -->
                                <div class="payment-method mb-4">
                                    <h6 class="text-primary">
                                        <i class="fab fa-paypal me-2"></i>
                                        PayPal
                                    </h6>
                                    <p class="small mb-2">
                                        Envía el pago a: <strong>payments@davidsoto.com</strong>
                                    </p>
                                    <ol class="small">
                                        <li>Ingresa a tu cuenta PayPal</li>
                                        <li>Envía dinero a la dirección de email mostrada</li>
                                        <li>Agrega como nota: "Curso - {{ enrollment.course.title }}"</li>
                                        <li>Sube captura de pantalla de la transacción</li>
                                    </ol>
                                </div>

                                <!-- Tarjeta de Crédito -->
                                <div class="payment-method mb-4">
                                    <h6 class="text-primary">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Tarjeta de Crédito
                                    </h6>
                                    <p class="small">
                                        <em>Próximamente disponible - Por ahora usa transferencia o PayPal</em>
                                    </p>
                                </div>
                            </div>

                            <!-- Información Importante -->
                            <div class="alert alert-warning mt-3">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Importante</h6>
                                <ul class="mb-0 small">
                                    <li>El precio del curso incluye todos los materiales</li>
                                    <li>El acceso se activa en 24-48 horas después de la confirmación</li>
                                    <li>Guarda el comprobante para futuras referencias</li>
                                    <li>Contacta soporte si tienes problemas: support@davidsoto.com</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario para Continuar -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-upload me-2"></i>
                                Subir Comprobante de Pago
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <p class="mb-4">Una vez que hayas realizado el pago, sube tu comprobante para procesar tu inscripción.</p>
                            <a href="{{ url_for('enrollment.submit_payment', enrollment_id=enrollment.id) }}" 
                               class="btn btn-primary btn-lg">
                                <i class="fas fa-file-upload me-2"></i>
                                Subir Comprobante
                            </a>
                            <div class="mt-3">
                                <a href="{{ url_for('enrollment.my_enrollments') }}" 
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-list me-2"></i>
                                    Ver Mis Inscripciones
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar notificación de éxito
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>Número copiado al portapapeles';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }).catch(function(err) {
        console.error('Error al copiar: ', err);
        alert('No se pudo copiar automáticamente. Copia manualmente: ' + text);
    });
}
</script>

<style>
.bank-account {
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    transition: all 0.3s ease;
}

.bank-account:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.payment-method {
    border-left: 3px solid #007bff;
    padding-left: 15px;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

code {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.btn-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}
</style>
{% endblock %}
