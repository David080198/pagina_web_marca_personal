{% extends "base.html" %}

{% block title %}{{ post.title }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-5" style="padding-top: 120px !important;">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <article class="blog-article">
                {% if post.image_url %}
                <div class="blog-hero-image mb-4">
                    <img src="{{ post.image_url }}" class="img-fluid rounded" alt="{{ post.title }}">
                </div>
                {% endif %}
                
                <header class="mb-4">
                    <h1 class="blog-title mb-3">{{ post.title }}</h1>
                    <div class="blog-meta">
                        <span class="me-3">
                            <i class="fas fa-calendar-alt"></i> {{ post.created_at.strftime('%d de %B de %Y') }}
                        </span>
                        {% if post.updated_at and post.updated_at != post.created_at %}
                        <span class="me-3">
                            <i class="fas fa-edit"></i> Actualizado: {{ post.updated_at.strftime('%d de %B de %Y') }}
                        </span>
                        {% endif %}
                        {% if post.tags %}
                        <span>
                            <i class="fas fa-tags"></i>
                            {% for tag in post.tags.split(',') %}
                            <span class="badge bg-secondary">{{ tag.strip() }}</span>
                            {% endfor %}
                        </span>
                        {% endif %}
                    </div>
                </header>
                
                {% if post.summary %}
                <div class="blog-summary">
                    <p>{{ post.summary }}</p>
                </div>
                {% endif %}
                
                <!-- Contenido Markdown renderizado -->
                <div class="markdown-content" id="blog-content">
                    {{ post.content | safe }}
                </div>
                
                <footer class="blog-footer mt-5 pt-4">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <!-- Botones de Like y Favorito -->
                            <div class="d-flex align-items-center gap-3">
                                <button id="likeBtn" class="btn btn-like" onclick="toggleLike()">
                                    <i class="fas fa-heart" id="likeIcon"></i>
                                    <span id="likesCount">0</span>
                                </button>
                                <button id="favoriteBtn" class="btn btn-favorite" onclick="toggleFavorite()">
                                    <i class="fas fa-bookmark" id="favoriteIcon"></i>
                                    <span id="favoriteText">Guardar</span>
                                </button>
                                <a href="{{ url_for('main.blog') }}" class="btn btn-outline-neon">
                                    <i class="fas fa-arrow-left me-2"></i> Volver al Blog
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="me-3 text-muted">Compartir:</span>
                            <a href="https://twitter.com/intent/tweet?text={{ post.title | urlencode }}&url={{ request.url | urlencode }}" 
                               class="btn btn-sm btn-outline-info me-1" target="_blank" title="Compartir en Twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url | urlencode }}" 
                               class="btn btn-sm btn-outline-primary me-1" target="_blank" title="Compartir en LinkedIn">
                                <i class="fab fa-linkedin"></i>
                            </a>
                            <a href="mailto:?subject={{ post.title | urlencode }}&body=Lee este artículo: {{ request.url | urlencode }}" 
                               class="btn btn-sm btn-outline-secondary" title="Compartir por Email">
                                <i class="fas fa-envelope"></i>
                            </a>
                        </div>
                    </div>
                </footer>
                
                <!-- Sección de Comentarios -->
                <section class="comments-section mt-5">
                    <h4 class="section-title mb-4">
                        <i class="fas fa-comments me-2"></i>Comentarios 
                        <span class="badge bg-neon" id="commentsCount">0</span>
                    </h4>
                    
                    <!-- Formulario para agregar comentario -->
                    {% if current_user.is_authenticated %}
                    <div class="comment-form-wrapper mb-4">
                        <div class="d-flex gap-3">
                            <img src="{{ current_user.get_avatar_url(50) }}" 
                                 class="rounded-circle" 
                                 width="50" height="50" 
                                 alt="{{ current_user.display_name }}">
                            <div class="flex-grow-1">
                                <textarea id="commentInput" 
                                          class="form-control comment-input" 
                                          placeholder="Escribe un comentario..." 
                                          rows="3"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted"><span id="charCount">0</span>/2000 caracteres</small>
                                    <button id="submitComment" class="btn btn-neon" onclick="submitComment()">
                                        <i class="fas fa-paper-plane me-1"></i> Comentar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <a href="{{ url_for('auth.login') }}" class="alert-link">Inicia sesión</a> para dejar un comentario o dar like.
                    </div>
                    {% endif %}
                    
                    <!-- Lista de comentarios -->
                    <div id="commentsList" class="comments-list">
                        <div class="text-center py-4 text-muted" id="loadingComments">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Cargando comentarios...</p>
                        </div>
                    </div>
                </section>
            </article>
        </div>
    </div>
</div>

<!-- Marked.js para renderizar Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Highlight.js para syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentEl = document.getElementById('blog-content');
    const rawContent = contentEl.innerHTML;
    
    // Configurar marked con highlight.js
    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: true,
        mangle: false,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        }
    });
    
    // Detectar si el contenido parece ser Markdown (contiene caracteres MD típicos)
    const looksLikeMarkdown = /^#|^\*|^\-\s|\[.*\]\(|```/.test(rawContent.trim());
    
    if (looksLikeMarkdown) {
        // Decodificar entidades HTML antes de parsear
        const decoded = rawContent
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"');
        
        contentEl.innerHTML = marked.parse(decoded);
    }
    
    // Aplicar highlight a bloques de código que no fueron procesados
    document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
});
</script>

<style>
/* Blog Article Styles */
.blog-article {
    background: linear-gradient(145deg, rgba(10, 25, 47, 0.95), rgba(0, 20, 40, 0.98));
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 40px;
}

.blog-hero-image img {
    border: 1px solid rgba(0, 212, 255, 0.3);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.blog-title {
    color: #fff;
    font-family: 'Orbitron', monospace;
    font-size: 2.5rem;
    line-height: 1.3;
}

.blog-meta {
    color: #6b7280;
    font-size: 0.9rem;
}

.blog-meta i {
    color: #00d4ff;
    margin-right: 5px;
}

.blog-summary {
    background: rgba(0, 212, 255, 0.1);
    border-left: 4px solid #00d4ff;
    padding: 20px;
    margin: 25px 0;
    border-radius: 0 8px 8px 0;
}

.blog-summary p {
    margin: 0;
    color: #e5e7eb;
    font-style: italic;
}

.blog-footer {
    border-top: 1px solid rgba(0, 212, 255, 0.2);
}

/* Markdown Content Styles */
.markdown-content {
    color: #e5e7eb;
    font-size: 1.1rem;
    line-height: 1.8;
}

.markdown-content h1, 
.markdown-content h2, 
.markdown-content h3, 
.markdown-content h4, 
.markdown-content h5, 
.markdown-content h6 {
    color: #00d4ff;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-family: 'Orbitron', monospace;
}

.markdown-content h1 { 
    font-size: 2em; 
    border-bottom: 1px solid rgba(0, 212, 255, 0.3); 
    padding-bottom: 0.5rem; 
}
.markdown-content h2 { 
    font-size: 1.6em; 
    border-bottom: 1px solid rgba(0, 212, 255, 0.2); 
    padding-bottom: 0.3rem; 
}
.markdown-content h3 { font-size: 1.3em; }
.markdown-content h4 { font-size: 1.1em; }

.markdown-content p {
    margin-bottom: 1.2rem;
}

.markdown-content a {
    color: #00d4ff;
    text-decoration: none;
    border-bottom: 1px dashed rgba(0, 212, 255, 0.5);
    transition: all 0.2s;
}

.markdown-content a:hover {
    color: #fff;
    border-bottom-color: #fff;
}

.markdown-content code {
    background: #1e293b;
    padding: 3px 8px;
    border-radius: 4px;
    font-family: 'Fira Code', 'Monaco', monospace;
    font-size: 0.9em;
    color: #f472b6;
}

.markdown-content pre {
    background: #0d1117;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    border: 1px solid #374151;
    margin: 1.5rem 0;
}

.markdown-content pre code {
    background: none;
    padding: 0;
    color: #e5e7eb;
    font-size: 0.9rem;
    line-height: 1.6;
}

.markdown-content blockquote {
    border-left: 4px solid #00d4ff;
    padding: 15px 20px;
    margin: 1.5rem 0;
    background: rgba(0, 212, 255, 0.05);
    border-radius: 0 8px 8px 0;
    font-style: italic;
    color: #9ca3af;
}

.markdown-content blockquote p {
    margin-bottom: 0;
}

.markdown-content ul, 
.markdown-content ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content li::marker {
    color: #00d4ff;
}

.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
    border: 1px solid rgba(0, 212, 255, 0.2);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
}

.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
}

.markdown-content th, 
.markdown-content td {
    border: 1px solid #374151;
    padding: 12px 15px;
    text-align: left;
}

.markdown-content th {
    background: #1e293b;
    color: #00d4ff;
    font-weight: 600;
}

.markdown-content tr:nth-child(even) {
    background: rgba(0, 0, 0, 0.2);
}

.markdown-content hr {
    border: none;
    border-top: 1px solid rgba(0, 212, 255, 0.3);
    margin: 2.5rem 0;
}

.markdown-content input[type="checkbox"] {
    margin-right: 8px;
    accent-color: #00d4ff;
}

/* Responsive */
@media (max-width: 768px) {
    .blog-article {
        padding: 20px;
    }
    
    .blog-title {
        font-size: 1.8rem;
    }
    
    .markdown-content {
        font-size: 1rem;
    }
}

/* Like Button Styles */
.btn-like {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: 2px solid #374151;
    background: transparent;
    color: #9ca3af;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-like:hover {
    border-color: #ff4757;
    color: #ff4757;
    transform: scale(1.05);
}

.btn-like.liked {
    border-color: #ff4757;
    background: rgba(255, 71, 87, 0.1);
    color: #ff4757;
}

.btn-like.liked i {
    animation: heartbeat 0.5s ease;
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
}

/* Favorite Button Styles */
.btn-favorite {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: 2px solid #374151;
    background: transparent;
    color: #9ca3af;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-favorite:hover {
    border-color: #00d4ff;
    color: #00d4ff;
    transform: scale(1.05);
}

.btn-favorite.favorited {
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.1);
    color: #00d4ff;
}

.btn-favorite.favorited i {
    animation: bookmark-pop 0.4s ease;
}

@keyframes bookmark-pop {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2) rotate(10deg); }
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 15px 25px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(0, 212, 255, 0.3);
    color: #fff;
    font-weight: 500;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 9999;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
}

.toast-notification.show {
    opacity: 1;
    transform: translateY(0);
}

.toast-notification.toast-success {
    border-color: #00ff88;
    color: #00ff88;
}

.toast-notification.toast-info {
    border-color: #00d4ff;
    color: #00d4ff;
}

/* Comments Section Styles */
.comments-section {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 30px;
    margin-top: 40px;
}

.section-title {
    color: #fff;
    font-family: 'Orbitron', monospace;
    font-size: 1.4rem;
}

.badge.bg-neon {
    background: linear-gradient(135deg, #00d4ff, #0099cc) !important;
    color: #0a1929;
}

.comment-input {
    background: #1e293b;
    border: 1px solid #374151;
    color: #e5e7eb;
    resize: none;
}

.comment-input:focus {
    background: #1e293b;
    border-color: #00d4ff;
    color: #e5e7eb;
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15);
}

.btn-neon {
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    border: none;
    color: #0a1929;
    font-weight: 600;
    padding: 8px 20px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.btn-neon:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
    color: #0a1929;
}

/* Comment Items */
.comment-item {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid #374151;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.2s ease;
}

.comment-item:hover {
    border-color: rgba(0, 212, 255, 0.3);
}

.comment-item.pinned {
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.05);
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.comment-avatar {
    border: 2px solid #374151;
}

.comment-user-info {
    flex-grow: 1;
}

.comment-username {
    color: #00d4ff;
    font-weight: 600;
    text-decoration: none;
}

.comment-username:hover {
    color: #fff;
}

.comment-date {
    color: #6b7280;
    font-size: 0.85rem;
}

.comment-content {
    color: #e5e7eb;
    line-height: 1.6;
    margin-bottom: 12px;
}

.comment-actions {
    display: flex;
    gap: 15px;
}

.comment-action-btn {
    background: none;
    border: none;
    color: #6b7280;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
    transition: all 0.2s;
}

.comment-action-btn:hover {
    background: rgba(0, 212, 255, 0.1);
    color: #00d4ff;
}

.comment-action-btn.delete:hover {
    background: rgba(255, 71, 87, 0.1);
    color: #ff4757;
}

/* Replies */
.comment-replies {
    margin-left: 30px;
    margin-top: 15px;
    padding-left: 20px;
    border-left: 2px solid #374151;
}

.reply-item {
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.reply-form {
    background: rgba(15, 23, 42, 0.5);
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

.reply-input {
    background: #1e293b;
    border: 1px solid #374151;
    color: #e5e7eb;
    font-size: 0.9rem;
}

.reply-input:focus {
    background: #1e293b;
    border-color: #00d4ff;
    color: #e5e7eb;
}

/* No comments state */
.no-comments {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.no-comments i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Edit comment modal */
.edit-textarea {
    background: #1e293b;
    border: 1px solid #374151;
    color: #e5e7eb;
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    resize: none;
}

.edit-textarea:focus {
    border-color: #00d4ff;
    outline: none;
}
</style>

<script>
// Variables globales
const postId = {{ post.id }};
const contentType = 'blog';
const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};

// Cargar likes y comentarios al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadLikeStatus();
    loadFavoriteStatus();
    loadComments();
    
    // Contador de caracteres para comentarios
    const commentInput = document.getElementById('commentInput');
    if (commentInput) {
        commentInput.addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });
    }
});

// =====================
// Funciones de Likes
// =====================

function loadLikeStatus() {
    fetch(`/api/like/${contentType}/${postId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateLikeUI(data.liked, data.likes_count);
            }
        })
        .catch(error => console.error('Error loading likes:', error));
}

function toggleLike() {
    if (!isAuthenticated) {
        window.location.href = "{{ url_for('auth.login') }}?next={{ request.url | urlencode }}";
        return;
    }
    
    fetch(`/api/like/${contentType}/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateLikeUI(data.liked, data.likes_count);
        } else {
            alert(data.error || 'Error al procesar el like');
        }
    })
    .catch(error => {
        console.error('Error toggling like:', error);
        alert('Error de conexión');
    });
}

function updateLikeUI(liked, count) {
    const likeBtn = document.getElementById('likeBtn');
    const likeIcon = document.getElementById('likeIcon');
    const likesCount = document.getElementById('likesCount');
    
    likesCount.textContent = count;
    
    if (liked) {
        likeBtn.classList.add('liked');
        likeIcon.classList.remove('far');
        likeIcon.classList.add('fas');
    } else {
        likeBtn.classList.remove('liked');
        likeIcon.classList.remove('fas');
        likeIcon.classList.add('far');
    }
}

// =====================
// Funciones de Favoritos
// =====================

function loadFavoriteStatus() {
    fetch(`/api/favorite/${contentType}/${postId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateFavoriteUI(data.favorited);
            }
        })
        .catch(error => console.error('Error loading favorite status:', error));
}

function toggleFavorite() {
    if (!isAuthenticated) {
        window.location.href = "{{ url_for('auth.login') }}?next={{ request.url | urlencode }}";
        return;
    }
    
    fetch(`/api/favorite/${contentType}/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateFavoriteUI(data.favorited);
            // Mostrar feedback
            const message = data.favorited ? '¡Agregado a favoritos!' : 'Eliminado de favoritos';
            showToast(message, data.favorited ? 'success' : 'info');
        } else {
            alert(data.error || 'Error al procesar el favorito');
        }
    })
    .catch(error => {
        console.error('Error toggling favorite:', error);
        alert('Error de conexión');
    });
}

function updateFavoriteUI(favorited) {
    const favoriteBtn = document.getElementById('favoriteBtn');
    const favoriteIcon = document.getElementById('favoriteIcon');
    const favoriteText = document.getElementById('favoriteText');
    
    if (favorited) {
        favoriteBtn.classList.add('favorited');
        favoriteIcon.classList.remove('far');
        favoriteIcon.classList.add('fas');
        favoriteText.textContent = 'Guardado';
    } else {
        favoriteBtn.classList.remove('favorited');
        favoriteIcon.classList.remove('fas');
        favoriteIcon.classList.add('far');
        favoriteText.textContent = 'Guardar';
    }
}

function showToast(message, type = 'info') {
    // Crear toast temporal
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}`;
    document.body.appendChild(toast);
    
    // Mostrar y ocultar
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

// =====================
// Funciones de Comentarios
// =====================

function loadComments() {
    fetch(`/api/comments/${contentType}/${postId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderComments(data.comments);
                document.getElementById('commentsCount').textContent = data.count;
            }
        })
        .catch(error => {
            console.error('Error loading comments:', error);
            document.getElementById('commentsList').innerHTML = `
                <div class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>Error al cargar comentarios</p>
                </div>
            `;
        });
}

function renderComments(comments) {
    const container = document.getElementById('commentsList');
    
    if (comments.length === 0) {
        container.innerHTML = `
            <div class="no-comments">
                <i class="fas fa-comments"></i>
                <p>Sé el primero en comentar</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = comments.map(comment => `
        <div class="comment-item ${comment.is_pinned ? 'pinned' : ''}" id="comment-${comment.id}">
            ${comment.is_pinned ? '<span class="badge bg-info mb-2"><i class="fas fa-thumbtack me-1"></i>Fijado</span>' : ''}
            <div class="comment-header">
                <img src="${comment.user.avatar_url}" class="rounded-circle comment-avatar" width="50" height="50" alt="${comment.user.display_name}">
                <div class="comment-user-info">
                    <a href="/user/profile/${comment.user.username}" class="comment-username">${comment.user.display_name}</a>
                    <div class="comment-date">${formatDate(comment.created_at)}</div>
                </div>
            </div>
            <div class="comment-content" id="content-${comment.id}">${escapeHtml(comment.content)}</div>
            <div class="comment-actions">
                ${isAuthenticated ? `<button class="comment-action-btn" onclick="showReplyForm(${comment.id})"><i class="fas fa-reply me-1"></i>Responder</button>` : ''}
                ${comment.can_edit ? `<button class="comment-action-btn" onclick="editComment(${comment.id})"><i class="fas fa-edit me-1"></i>Editar</button>` : ''}
                ${comment.can_delete ? `<button class="comment-action-btn delete" onclick="deleteComment(${comment.id})"><i class="fas fa-trash me-1"></i>Eliminar</button>` : ''}
            </div>
            <div id="reply-form-${comment.id}" class="reply-form" style="display: none;">
                <textarea class="form-control reply-input" id="reply-input-${comment.id}" rows="2" placeholder="Escribe una respuesta..."></textarea>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="hideReplyForm(${comment.id})">Cancelar</button>
                    <button class="btn btn-sm btn-neon" onclick="submitReply(${comment.id})">Responder</button>
                </div>
            </div>
            ${comment.replies.length > 0 ? `
                <div class="comment-replies">
                    ${comment.replies.map(reply => `
                        <div class="reply-item" id="comment-${reply.id}">
                            <div class="comment-header">
                                <img src="${reply.user.avatar_url}" class="rounded-circle comment-avatar" width="40" height="40" alt="${reply.user.display_name}">
                                <div class="comment-user-info">
                                    <a href="/user/profile/${reply.user.username}" class="comment-username">${reply.user.display_name}</a>
                                    <div class="comment-date">${formatDate(reply.created_at)}</div>
                                </div>
                            </div>
                            <div class="comment-content" id="content-${reply.id}">${escapeHtml(reply.content)}</div>
                            <div class="comment-actions">
                                ${reply.can_edit ? `<button class="comment-action-btn" onclick="editComment(${reply.id})"><i class="fas fa-edit me-1"></i>Editar</button>` : ''}
                                ${reply.can_delete ? `<button class="comment-action-btn delete" onclick="deleteComment(${reply.id})"><i class="fas fa-trash me-1"></i>Eliminar</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `).join('');
}

function submitComment() {
    const input = document.getElementById('commentInput');
    const content = input.value.trim();
    
    if (!content) {
        alert('Escribe un comentario');
        return;
    }
    
    if (content.length < 3) {
        alert('El comentario es muy corto');
        return;
    }
    
    fetch(`/api/comments/${contentType}/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            document.getElementById('charCount').textContent = '0';
            loadComments();
        } else {
            alert(data.error || 'Error al publicar comentario');
        }
    })
    .catch(error => {
        console.error('Error submitting comment:', error);
        alert('Error de conexión');
    });
}

function showReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'block';
    document.getElementById(`reply-input-${commentId}`).focus();
}

function hideReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'none';
    document.getElementById(`reply-input-${commentId}`).value = '';
}

function submitReply(parentId) {
    const input = document.getElementById(`reply-input-${parentId}`);
    const content = input.value.trim();
    
    if (!content) {
        alert('Escribe una respuesta');
        return;
    }
    
    fetch(`/api/comments/${contentType}/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content, parent_id: parentId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideReplyForm(parentId);
            loadComments();
        } else {
            alert(data.error || 'Error al publicar respuesta');
        }
    })
    .catch(error => {
        console.error('Error submitting reply:', error);
        alert('Error de conexión');
    });
}

function editComment(commentId) {
    const contentEl = document.getElementById(`content-${commentId}`);
    const currentContent = contentEl.textContent;
    
    contentEl.innerHTML = `
        <textarea class="edit-textarea" id="edit-input-${commentId}" rows="3">${currentContent}</textarea>
        <div class="d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="cancelEdit(${commentId}, '${escapeHtml(currentContent)}')">Cancelar</button>
            <button class="btn btn-sm btn-neon" onclick="saveEdit(${commentId})">Guardar</button>
        </div>
    `;
    document.getElementById(`edit-input-${commentId}`).focus();
}

function cancelEdit(commentId, originalContent) {
    document.getElementById(`content-${commentId}`).innerHTML = originalContent;
}

function saveEdit(commentId) {
    const input = document.getElementById(`edit-input-${commentId}`);
    const content = input.value.trim();
    
    if (!content || content.length < 3) {
        alert('El comentario es muy corto');
        return;
    }
    
    fetch(`/api/comments/${commentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadComments();
        } else {
            alert(data.error || 'Error al editar comentario');
        }
    })
    .catch(error => {
        console.error('Error editing comment:', error);
        alert('Error de conexión');
    });
}

function deleteComment(commentId) {
    if (!confirm('¿Estás seguro de eliminar este comentario?')) {
        return;
    }
    
    fetch(`/api/comments/${commentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadComments();
        } else {
            alert(data.error || 'Error al eliminar comentario');
        }
    })
    .catch(error => {
        console.error('Error deleting comment:', error);
        alert('Error de conexión');
    });
}

// Utilidades
function formatDate(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diff = (now - date) / 1000;
    
    if (diff < 60) return 'Hace un momento';
    if (diff < 3600) return `Hace ${Math.floor(diff / 60)} minutos`;
    if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
    if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} días`;
    
    return date.toLocaleDateString('es-ES', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
